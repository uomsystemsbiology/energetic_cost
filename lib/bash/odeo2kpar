#!/bin/bash

## Find the symbolic parameters associated with states from odeo.m file

sys=$1
inname=${sys}_odeo.m
outname=${sys}_K.m

echo Creating $outname

echo "function [K i_lin] = ${sys}_K(mttpar)"           > $outname
echo "## function [K i_lin] = ${sys}_K(mttpar)"       >> $outname
echo "## Generated by odeo2kpar on `date`" >> $outname
echo >> $outname
echo "## Parameters "  >> $outname
grep 'mttpar(' $inname >> $outname
 
echo >> $outname
echo "## Free-energy constants" >> $outname
 tr '\n' '!' < $inname |\
 sed 's/\\!//g' |\
 sed 's/cp(/\ncp(/g' |\
 grep '^cp' |\
 awk -F ',' '{print $6,$2}' |\
 sed 's/mttx//' |\
 sort -un |\
 awk '{print "  K("$1",1) = ", $2 ";"}' >> $outname

echo "if (min(K)==0); warning(\"K has a zero element\"); endif" >> $outname

echo "## Index of linear Cs" >> $outname
echo "i_lin = [];" >> $outname
 tr '\n' '!' < $inname |\
 sed 's/\\!//g' |\
 sed 's/lcp(/\nlcp(/g' |\
 grep '^lcp' |\
 awk -F ',' '{print $6}' |\
 sed 's/mttx//' |\
 sort -un |\
 awk '{print "i_lin = [i_lin", $1, "];"}' >> $outname

echo "endfunction" >> $outname
